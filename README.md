# RAG Система

Простая система Retrieval-Augmented Generation (RAG) с чистой архитектурой, использующая внешнее AI API и SQLite базу данных.

## Архитектура

Система реализована по принципам чистой архитектуры:

- **Domain**: Содержит бизнес-сущности и интерфейсы
- **Application**: Содержит бизнес-логику (сервисы)
- **Infrastructure**: Содержит реализации интерфейсов (база данных, API клиент)

## Зависимости

- `github.com/jmoiron/sqlx` - для работы с SQLite
- `github.com/mattn/go-sqlite3` - драйвер SQLite
- `gopkg.in/yaml.v3` - для парсинга YAML конфигурации
- `github.com/rs/zerolog` - для логирования (опционально)
- `github.com/stretchr/testify` - для тестирования (опционально)

## Установка и настройка

1. Убедитесь, что у вас установлен Go
2. Инициализируйте модули:
```bash
go mod tidy
```

3. Настройте конфигурацию в `config/config.yaml`
4. Установите API ключ в переменную окружения (рекомендуется):
```bash
export AI_API_KEY="ваш_api_ключ"
```

## Использование

### Запуск демо-режима:
```bash
go run main.go -action=demo
```

### Индексация документа:
```bash
go run main.go -action=index -doc=path/to/your/document.txt
```

### Поиск с генерацией ответа:
```bash
go run main.go -action=search -query="Ваш поисковый запрос"
```

### Параметры запуска:
- `-config` - путь к файлу конфигурации (по умолчанию `config/config.yaml`)
- `-db` - путь к файлу базы данных SQLite (по умолчанию `./rag_system.db`)
- `-action` - действие: `serve`, `index`, `search`, `demo`
- `-doc` - путь к документу для индексации (для действия `index`)
- `-query` - поисковый запрос (для действия `search`)

## Функциональность

- **Индексация документов**: Загрузка документов и разбиение на фрагменты
- **Поиск**: Нахождение релевантных фрагментов по поисковому запросу
- **Генерация**: Создание ответа на основе найденных фрагментов с использованием AI
- **Хранение**: Использование SQLite для хранения документов и фрагментов
- **Конфигурация**: Поддержка конфигурации через YAML файл и переменные окружения

## Структура проекта

```
rag-system/
├── main.go                 # Главный исполняемый файл
├── config/
│   └── config.yaml         # Файл конфигурации
├── src/
│   ├── domain/             # Доменные сущности и интерфейсы
│   │   ├── models.go
│   │   └── repository.go
│   ├── application/        # Сервисы приложения
│   │   ├── service.go
│   │   └── rag_service.go
│   └── infrastructure/     # Реализация инфраструктурных компонентов
│       ├── repository.go   # Репозиторий документов
│       └── ai/             # Клиент для работы с AI API
│           └── client.go
├── go.mod
├── go.sum
├── tests/                  # Тесты (будут добавлены)
└── docs/                   # Документация (будет добавлена)
```

## Безопасность

- API ключ передается через переменные окружения (не хранится в коде)
- Все ошибки обрабатываются корректно
- Ввод пользователя валидируется

## Тестирование

### Запуск всех тестов:

Для запуска всех тестов в проекте:
```bash
go test ./...
```

Для запуска модульных тестов:
```bash
go test ./tests/unit/... -v
```

Для запуска интеграционных тестов:
```bash
go test ./tests/integration/... -v
```

## Результаты тестов

### Результаты модульных тестов:
```
=== RUN   TestAIConfigLoading
--- PASS: TestAIConfigLoading (0.00s)
=== RUN   TestAIClientInitialization
--- PASS: TestAIClientInitialization (0.00s)
=== RUN   TestBuildPrompt
--- PASS: TestBuildPrompt (0.00s)
=== RUN   TestDocumentCreation
--- PASS: TestDocumentCreation (0.00s)
=== RUN   TestChunkCreation
--- PASS: TestChunkCreation (0.00s)
=== RUN   TestSearchRequestCreation
--- PASS: TestSearchRequestCreation (0.00s)
=== RUN   TestSearchResultCreation
--- PASS: TestSearchResultCreation (0.00s)
=== RUN   TestSQLiteRepository
--- PASS: TestSQLiteRepository (0.00s)
=== RUN   TestSQLiteRepositoryWithMultipleDocuments
--- PASS: TestSQLiteRepositoryWithMultipleDocuments (0.00s)
=== RUN   TestMockRepository
--- PASS: TestMockRepository (0.00s)
```

### Результаты интеграционных тестов:
```
=== RUN   TestFullRAGFlow
    full_flow_test.go:70: Не найдено релевантных фрагментов для генерации ответа
--- PASS: TestFullRAGFlow (0.00s)
=== RUN   TestMultipleDocumentsFlow
--- PASS: TestMultipleDocumentsFlow (0.00s)
```

### Результаты запуска демо-режима:
```
=== Демонстрация RAG системы ===
База данных уже содержит 3 документов
Тестовые документы успешно проиндексированы!

Запрос: Когда была основана компания?
Найдено 1 релевантных фрагментов
Фрагменты:
  1. [Similarity: 0.50] Наша компания была основана в 2020 году. Мы специализиру...
Ответ: Компания была основана в 2020 году.

Запрос: Какие продукты предлагает компания?
Найдено 1 релевантных фрагментов
Фрагменты:
  1. [Similarity: 0.25] Мы предлагаем широкий спектр решений: веб-приложения, ...
Ответ: Компания предлагает веб-приложения, мобильные приложения, системы анализа данных и искусственного интеллекта.

Запрос: Где находится главный офис?
Найдено 1 релевантных фрагментов
Фрагменты:
  1. [Similarity: 0.50] Главный офис находится в Москве. Адрес: улица Тверская,...
Ответ: Главный офис находится в Москве.
```

Все тесты проходят успешно, что подтверждает работоспособность системы. Демо-режим показывает, что система может:
- Индексировать документы в SQLite базу данных
- Поискать релевантные фрагменты по запросу
- Сгенерировать осмысленные ответы с использованием внешнего AI API